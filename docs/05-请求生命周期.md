# ThinkPHP 请求生命周期

本文档详细讲解 ThinkPHP 从接收请求到返回响应的完整生命周期。

## 生命周期概览

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户发起请求                              │
│                    GET /voddetail/123.html                      │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  1. 入口文件 (index.php)                                        │
│     - 定义常量 (ROOT_PATH, APP_PATH, BIND_MODULE)               │
│     - 加载框架 require 'thinkphp/start.php'                     │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  2. 框架引导 (thinkphp/start.php)                               │
│     - 加载基础文件 base.php                                      │
│     - 执行 App::run()->send()                                   │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  3. 基础初始化 (thinkphp/base.php)                              │
│     - 定义框架常量                                               │
│     - 注册自动加载 Loader::register()                           │
│     - 注册错误处理 Error::register()                            │
│     - 加载惯例配置 convention.php                                │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  4. 应用初始化 (App::run)                                       │
│     - 加载应用配置 config.php                                    │
│     - 加载扩展配置 extra/*.php                                   │
│     - 加载公共函数 common.php                                    │
│     - 加载语言包 lang/                                           │
│     ──────────────────────────────────────────                  │
│     ★ 触发 app_init 钩子                                        │
│       └→ Init::run() 初始化全局常量                             │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  5. 应用开始                                                     │
│     ★ 触发 app_begin 钩子                                       │
│       └→ Begin::run() 应用启动处理                              │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  6. 路由解析                                                     │
│     - 解析 URL: /voddetail/123.html                             │
│     - 匹配路由规则: 'voddetail/<id>' => 'vod/detail'            │
│     - 确定: 模块=index, 控制器=Vod, 操作=detail, 参数=id:123    │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  7. 模块初始化                                                   │
│     - 加载模块配置 index/config.php                              │
│     - 加载模块函数 index/common.php                              │
│     ★ 触发 module_init 钩子                                     │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  8. 控制器调度                                                   │
│     - 实例化控制器: new app\index\controller\Vod()              │
│     - 执行构造方法 __construct()                                 │
│     ★ 触发 action_begin 钩子                                    │
│     - 执行操作方法 detail($id)                                   │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  9. 业务逻辑处理                                                 │
│     - 控制器调用模型: model('Vod')->getDetail($id)              │
│     - 模型查询数据库                                             │
│     - 处理业务逻辑                                               │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  10. 视图渲染                                                    │
│      - 加载模板: template/default/vod/detail.html               │
│      - 解析模板标签 {maccms:...}                                 │
│      - 编译模板 → runtime/temp/                                  │
│      ★ 触发 view_filter 钩子                                    │
│      - 生成 HTML 内容                                            │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  11. 响应输出                                                    │
│      - 创建 Response 对象                                        │
│      - 设置响应头                                                │
│      ★ 触发 app_end 钩子                                        │
│      - 输出内容 Response::send()                                │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│                        用户收到响应                              │
│                     HTML页面/JSON数据                            │
└─────────────────────────────────────────────────────────────────┘
```

## 详细阶段说明

### 阶段1: 入口文件

```php
// index.php

// 定义应用路径
define('ROOT_PATH', __DIR__ . '/');
define('APP_PATH', __DIR__ . '/application/');

// 绑定默认模块 (不同入口绑定不同模块)
define('BIND_MODULE', 'index');  // admin.php 则为 'admin'
define('ENTRANCE', 'index');

// 记录启动时间
define('MAC_START_TIME', microtime(true));

// 检查安装锁
if (!is_file('./application/data/install/install.lock')) {
    header("Location: ./install.php");
    exit;
}

// 加载框架
require __DIR__ . '/thinkphp/start.php';
```

### 阶段2-3: 框架引导和基础初始化

```php
// thinkphp/start.php
require __DIR__ . '/base.php';
App::run()->send();

// thinkphp/base.php
define('THINK_VERSION', '5.0.24');
define('THINK_PATH', __DIR__ . '/');
define('LIB_PATH', THINK_PATH . 'library/');
// ... 更多常量

// 注册自动加载
\think\Loader::register();

// 注册错误处理
\think\Error::register();

// 加载惯例配置
\think\Config::set(include THINK_PATH . 'convention.php');
```

### 阶段4: 应用初始化 (App::run)

```php
// think/App.php::run()

// 加载应用配置
Config::load(APP_PATH . 'config.php');

// 加载扩展配置
$files = glob(APP_PATH . 'extra/*.php');
foreach ($files as $file) {
    Config::load($file, pathinfo($file, PATHINFO_FILENAME));
}

// 加载公共文件
include APP_PATH . 'common.php';

// 加载行为定义
Hook::import(include APP_PATH . 'tags.php');

// 触发 app_init 钩子
Hook::listen('app_init');
```

### 阶段5: app_begin 钩子

```php
// application/common/behavior/Begin.php

class Begin {
    public function run() {
        // 全局初始化操作
        // 检查维护模式
        // 初始化配置
        // 设置时区等
    }
}
```

### 阶段6: 路由解析

```php
// 请求 URL: /voddetail/123.html

// 路由规则 (route.php)
'/<id>' => 'vod/detail'

// 解析结果
$dispatch = [
    'module'     => 'index',      // 从 BIND_MODULE 获取
    'controller' => 'Vod',        // 从路由规则获取
    'action'     => 'detail',     // 从路由规则获取
    'param'      => ['id' => 123] // 从URL参数获取
];
```

### 阶段7-8: 控制器执行

```php
// 实例化控制器
$controller = new \app\index\controller\Vod();

// 调用操作方法
$response = $controller->detail();

// 控制器代码示例
class Vod extends Base {
    public function detail() {
        $id = input('id');

        // 调用模型
        $model = model('Vod');
        $data = $model->getDetail($id);

        // 渲染视图
        return $this->fetch('vod/detail', ['data' => $data]);
    }
}
```

### 阶段9: 模型数据处理

```php
// application/common/model/Vod.php

class Vod extends Base {
    public function getDetail($id) {
        // 构建查询
        $result = $this->where('vod_id', $id)
                       ->where('vod_status', 1)
                       ->find();

        // 处理数据
        if ($result) {
            // 增加点击数
            $this->where('vod_id', $id)->setInc('vod_hits');
        }

        return $result;
    }
}
```

### 阶段10: 视图渲染

```php
// 模板路径: template/default/vod/detail.html

// 模板内容示例
<h1>{$data.vod_name}</h1>

{maccms:vod num="10" order="time" by="desc"}
    <a href="{$vo.vod_url}">{$vo.vod_name}</a>
{/maccms:vod}

// 模板编译后缓存到
// runtime/temp/md5(模板路径).php
```

### 阶段11: 响应输出

```php
// Response::send()

// 设置响应头
header('Content-Type: text/html; charset=utf-8');

// 输出内容
echo $content;

// 触发 app_end 钩子
Hook::listen('app_end');
```

## 不同请求类型的处理

### HTML 页面请求

```
/voddetail/123.html
    → index.php
    → index 模块
    → Vod 控制器
    → detail 操作
    → 渲染 HTML 模板
    → 返回 HTML
```

### API JSON 请求

```
/api.php/vod/get_detail?vod_id=123
    → api.php
    → api 模块
    → Vod 控制器
    → get_detail 操作
    → 返回 JSON
```

```php
// API 控制器
class Vod extends Base {
    public function get_detail() {
        $id = input('vod_id');
        $data = model('Vod')->getDetail($id);

        return json([
            'code' => 1,
            'msg'  => 'ok',
            'data' => $data
        ]);
    }
}
```

### 后台管理请求

```
/admin.php/vod/index
    → admin.php
    → admin 模块
    → Vod 控制器 (需要登录验证)
    → index 操作
    → 渲染后台模板
    → 返回 HTML
```

## 异常处理流程

```
发生异常
    ↓
Error::appException()
    ↓
根据 app_debug 配置
    ↓
调试模式: 显示详细错误信息
生产模式: 显示友好错误页面
    ↓
触发 log_write 钩子
    ↓
记录错误日志
```

## 缓存机制

```
模板缓存:
    runtime/temp/xxx.php        # 编译后的PHP文件

数据缓存:
    runtime/cache/xxx.php       # 文件缓存
    或 Redis/Memcache           # 内存缓存

日志文件:
    runtime/log/202311/25.log   # 按日期分目录
```

## 下一步

恭喜你已经了解了 ThinkPHP 的核心知识！可以开始阅读项目源码：

- `application/common/behavior/Init.php` - 了解应用初始化
- `application/common/model/Vod.php` - 了解模型实现
- `application/index/controller/Vod.php` - 了解控制器实现
- `application/common/taglib/Maccms.php` - 了解自定义标签