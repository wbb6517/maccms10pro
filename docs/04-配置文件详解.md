# 配置文件详解

本文档详细讲解 ThinkPHP 的配置系统和本项目的配置文件。

## 配置加载顺序

ThinkPHP 按以下顺序加载配置，后面的会覆盖前面的：

```
1. thinkphp/convention.php         # 框架惯例配置 (最低优先级)
         ↓
2. application/config.php          # 应用配置
         ↓
3. application/extra/*.php         # 扩展配置
         ↓
4. application/模块名/config.php   # 模块配置 (最高优先级)
```

## 配置获取方式

```php
// 获取所有配置
config();

// 获取单个配置
config('app_debug');

// 获取数组配置项
config('database.hostname');

// 获取扩展配置
config('maccms');           // extra/maccms.php 全部
config('maccms.site_name'); // 具体项

// 设置配置
config('app_debug', true);

// 助手函数
C('app_debug');             // 兼容写法
```

## application/config.php 详解

应用主配置文件，覆盖框架默认配置：

```php
return [
    // ==================== 应用设置 ====================

    // 应用命名空间
    'app_namespace'          => 'app',

    // 调试模式 (生产环境设为 false)
    'app_debug'              => false,

    // 是否显示页面Trace信息
    'app_trace'              => false,

    // 多模块支持
    'app_multi_module'       => true,

    // 时区设置
    'default_timezone'       => 'PRC',

    // 默认语言
    'default_lang'           => 'zh-cn',

    // ==================== 模块设置 ====================

    // 默认模块
    'default_module'         => 'index',

    // 禁止URL访问的模块
    'deny_module_list'       => ['common', 'data'],

    // 默认控制器
    'default_controller'     => 'Index',

    // 默认操作
    'default_action'         => 'index',

    // 空控制器处理
    'empty_controller'       => 'MyError',

    // ==================== URL设置 ====================

    // PATHINFO分隔符
    'pathinfo_depr'          => '-',

    // URL伪静态后缀 (多后缀用|分隔)
    'url_html_suffix'        => 'html|htm|shtm|shtml|xml',

    // 是否开启路由
    'url_route_on'           => false,

    // ==================== 模板设置 ====================

    'template' => [
        // 模板引擎类型
        'type'            => 'Think',

        // 模板路径
        'view_path'       => './template/',

        // 模板后缀
        'view_suffix'     => 'html',

        // 模板标签界定符
        'tpl_begin'       => '{',
        'tpl_end'         => '}',
        'taglib_begin'    => '{',
        'taglib_end'      => '}',

        // 预加载标签库 (苹果CMS自定义标签)
        'taglib_pre_load' => 'app\common\taglib\Maccms',
    ],

    // ==================== 缓存设置 ====================

    'cache' => [
        'type'   => 'File',
        'path'   => CACHE_PATH,
        'prefix' => '',
        'expire' => 600,    // 缓存有效期 (秒)
    ],

    // ==================== 日志设置 ====================

    'log' => [
        'type'  => 'test',  // 'File' 或 'test'
        'path'  => LOG_PATH,
        'level' => ['sql'], // 记录级别
    ],

    // ==================== 会话设置 ====================

    'session' => [
        'prefix'     => 'think',
        'type'       => '',          // 支持 redis/memcache
        'auto_start' => true,
    ],

    // ==================== 分页设置 ====================

    'paginate' => [
        'type'      => 'bootstrap',
        'var_page'  => 'page',
        'list_rows' => 20,
    ],
];
```

## application/database.php 详解

数据库连接配置：

```php
return [
    // 数据库类型
    'type'            => 'mysql',

    // 数据库连接DSN配置
    'dsn'             => '',

    // 服务器地址
    'hostname'        => '127.0.0.1',

    // 数据库名
    'database'        => 'maccms',

    // 用户名
    'username'        => 'root',

    // 密码
    'password'        => 'root',

    // 端口
    'hostport'        => '3306',

    // 数据库编码
    'charset'         => 'utf8',

    // 数据库表前缀
    'prefix'          => 'mac_',

    // 调试模式
    'debug'           => false,

    // 数据库部署方式 (0:单一服务器, 1:主从)
    'deploy'          => 0,

    // 读写分离
    'rw_separate'     => false,

    // 主服务器数量
    'master_num'      => 1,

    // 是否严格检查字段
    'fields_strict'   => true,

    // 自动写入时间戳
    'auto_timestamp'  => false,

    // 时间格式
    'datetime_format' => 'Y-m-d H:i:s',
];
```

## application/route.php 详解

URL路由规则配置：

```php
return [
    // 路由参数正则规则
    '__pattern__' => [
        'id'       => '[\s\S]*?',
        'page'     => '\d+',
        'wd'       => '[\s\S]*',
        'type'     => '[\s\S]*?',
        // ...
    ],

    // 路由规则定义
    // 格式: 'URL规则' => '模块/控制器/操作'

    // 首页
    'index-<page?>' => 'index/index',

    // 视频
    'vodtype/<id>-<page?>'     => 'vod/type',
    'voddetail/<id>'           => 'vod/detail',
    'vodplay/<id>-<sid>-<nid>' => 'vod/play',
    'voddown/<id>-<sid>-<nid>' => 'vod/down',
    'vodshow/<id>-<area?>-<by?>-<class?>-...' => 'vod/show',
    'vodsearch/<wd?>-...'      => 'vod/search',

    // 文章
    'arttype/<id>-<page?>'  => 'art/type',
    'artdetail-<id>-<page?>' => 'art/detail',
    'artshow/<id>-...'      => 'art/show',

    // 演员
    'actor-<page?>'      => 'actor/index',
    'actordetail-<id>'   => 'actor/detail',
    'actorshow/<area?>-...' => 'actor/show',

    // 专题
    'topic-<page?>'      => 'topic/index',
    'topicdetail-<id>'   => 'topic/detail',

    // 其他
    'gbook-<page?>' => 'gbook/index',
    'map'           => 'map/index',
    'rss'           => 'rss/index',
];
```

**路由参数说明：**
- `<id>` - 必须参数
- `<page?>` - 可选参数
- `-` - URL分隔符 (由 pathinfo_depr 配置)

## application/tags.php 详解

行为钩子定义文件：

```php
return [
    // 应用初始化
    'app_init' => [
        'app\common\behavior\Init',
    ],

    // 应用开始
    'app_begin' => [
        'app\common\behavior\Begin',
    ],

    // 模块初始化
    'module_init' => [],

    // 插件开始
    'addon_begin' => [],

    // 操作开始
    'action_begin' => [],

    // 视图内容过滤
    'view_filter' => [],

    // 日志写入
    'log_write' => [],

    // 应用结束
    'app_end' => [],
];
```

**钩子执行时机：**
```
请求开始
    ↓
app_init      # 应用初始化后
    ↓
app_begin     # 应用开始前
    ↓
module_init   # 模块初始化后
    ↓
action_begin  # 操作执行前
    ↓
view_filter   # 视图渲染后
    ↓
log_write     # 日志写入时
    ↓
app_end       # 应用结束前
```

## application/extra/ 扩展配置

### extra/maccms.php - 主业务配置

苹果CMS最核心的业务配置文件（约18KB）：

```php
return [
    // 站点信息
    'site_name'        => '苹果CMS',
    'site_url'         => 'http://localhost',
    'site_keywords'    => '',
    'site_description' => '',
    'site_icp'         => '',
    'site_qq'          => '',
    'site_email'       => '',

    // 安全设置
    'admin_path'       => 'admin',    // 后台路径
    'api_key'          => '',         // API密钥

    // 上传设置
    'upload_mode'      => 'local',
    'upload_max_size'  => 10240,

    // 采集设置
    'collect_api'      => '',
    'collect_key'      => '',

    // 播放设置
    'play_domain'      => '',

    // 缓存设置
    'cache_core'       => 1,
    'cache_time'       => 3600,

    // 其他业务配置...
];
```

### extra/vodplayer.php - 播放器配置

```php
return [
    'dplayer' => [
        'name' => 'DPlayer',
        'status' => 1,
        'from' => 'dplayer',
    ],
    'videojs' => [
        'name' => 'VideoJS',
        'status' => 1,
        'from' => 'videojs',
    ],
    // ...
];
```

### extra/vodserver.php - 视频源配置

```php
return [
    'kuyun' => [
        'name' => '酷云',
        'status' => 1,
    ],
    'm3u8' => [
        'name' => 'M3U8',
        'status' => 1,
    ],
    // ...
];
```

## 配置使用最佳实践

### 1. 获取配置

```php
// 推荐方式
$debug = config('app_debug');
$dbHost = config('database.hostname');
$siteName = config('maccms.site_name');

// 带默认值
$pageSize = config('maccms.page_size') ?: 20;
```

### 2. 动态设置配置

```php
// 运行时修改 (仅当前请求有效)
config('app_debug', true);

// 批量设置
config([
    'app_debug' => true,
    'app_trace' => true,
]);
```

### 3. 环境变量配置

创建 `.env` 文件用于区分开发/生产环境：

```ini
[database]
hostname = 127.0.0.1
database = maccms_dev
username = root
password = root

[app]
debug = true
```

```php
// 读取环境变量
$host = Env::get('database.hostname', '127.0.0.1');
```

## 下一步

- [05-请求生命周期.md](./05-请求生命周期.md) - 了解请求处理流程