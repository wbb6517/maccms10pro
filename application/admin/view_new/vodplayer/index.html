<!--
视频播放器列表页面 (VodPlayer List Template)
============================================================

【页面说明】
后台 "视频 → 播放器管理" 的列表页面
显示所有已配置的视频播放器

【功能按钮】
- 添加: 弹出iframe添加新播放器
- 导入: 跳转到导入页面
- 状态: 批量修改启用/禁用状态
- 解析状态: 批量修改解析开关

【列表字段】
- 排序(sort): 数字越大越靠前
- 编码(from): 唯一标识，需与服务器组匹配
- 名称(show): 播放器显示名称
- 状态(status): 启用/禁用
- 解析状态(ps): 是否启用解析
- 打开方式(target): 当前窗口/新窗口
- 独立解析地址(parse): 该播放器专用的解析接口
- 备注(des): 描述信息
- 提示(tip): 鼠标悬停提示

【操作按钮】
- 导出: 导出播放器配置为txt文件
- 编辑: 弹出iframe编辑播放器
- 删除: 删除播放器配置

【模板变量】
- list: 播放器配置数组

@template    admin@vodplayer/index
@controller  app\admin\controller\Vodplayer::index()
-->
{include file="../../../application/admin/view_new/public/head" /}
<div class="page-container p10">
    <div class="my-toolbar-box">

        <div class="flex gap-5 overflow-x-auto overflow-y-hidden">
            <!-- 添加按钮: 弹出iframe添加新播放器 -->
            <a data-href="{:url('info')}" class="layui-btn layui-btn-primary j-iframe"><i class="layui-icon">&#xe654;</i>{:lang('add')}</a>
            <!-- 导入按钮: 跳转到导入页面 -->
            <a href="{:url('import')}" class="layui-btn layui-btn-primary" ><i class="layui-icon">&#xe654;</i>{:lang('import')}</a>
            <!-- 批量修改状态 -->
            <a data-href="{:url('index/select')}?tab=vod&col=status&tpl=select_state&url=vodplayer/field" data-width="470" data-height="100" data-checkbox="1" class="layui-btn layui-btn-primary j-select"><i class="layui-icon">&#xe620;</i>{:lang('status')}</a>
            <!-- 批量修改解析状态 -->
            <a data-href="{:url('index/select')}?tab=vod&col=ps&tpl=select_state&url=vodplayer/field" data-width="470" data-height="100" data-checkbox="1" class="layui-btn layui-btn-primary j-select"><i class="layui-icon">&#xe620;</i>{:lang('status_parse')}</a>
        </div>

    </div>

    <form class="layui-form " method="post" id="pageListForm">
        <!-- 播放器列表表格 -->
        <table class="layui-table" lay-size="sm">
            <thead>
            <tr>
                <th width="25"><input type="checkbox" lay-skin="primary" lay-filter="allChoose"></th>
                <th width="60">{:lang('sort')}</th>                          <!-- 排序值 -->
                <th width="60">{:lang('code')}</th>                          <!-- 编码 -->
                <th width="130">{:lang('name')}</th>                         <!-- 名称 -->
                <th width="60">{:lang('status')}</th>                        <!-- 状态 -->
                <th width="80">{:lang('status_parse')}</th>                  <!-- 解析状态 -->
                <th width="80">{:lang('target')}</th>                        <!-- 打开方式 -->
                <th width="130">{:lang('admin/vodplayer/alone_api_url')}</th><!-- 独立解析地址 -->
                <th width="130">{:lang('remarks')}</th>                      <!-- 备注 -->
                <th >{:lang('tip')}</th>                                     <!-- 提示 -->
                <th width="200">{:lang('opt')}</th>                          <!-- 操作 -->
            </tr>
            </thead>

            <!-- 遍历播放器列表 -->
            {volist name="list" id="vo"}
            <tr>
                <td><input type="checkbox" name="ids[]" value="{$vo.from}" class="layui-checkbox checkbox-ids" lay-skin="primary"></td>
                <td>
                    <!-- 排序快速编辑 -->
                    <input type="text" class="layui-input j-sort-input" data-id="{$vo.from}" value="{$vo.sort}" style="width:60px;text-align:center;padding:0 5px;height:28px;">
                </td>
                <td>{$vo.from}</td>
                <td>{$vo.show}</td>
                <!-- 状态显示: 绿色=启用, 红色=禁用 -->
                <td>{if condition="$vo.status eq 1"}<span class="layui-badge layui-bg-green">{:lang('enable')}</span>{else}<span class="layui-badge">{:lang('disable')}</span>{/if} </td>
                <!-- 解析状态: 绿色=启用, 红色=禁用 -->
                <td>{if condition="$vo.ps eq 1"}<span class="layui-badge layui-bg-green">{:lang('enable')}</span>{else}<span class="layui-badge">{:lang('disable')}</span>{/if} </td>
                <!-- 打开方式: 绿色=当前窗口, 红色=新窗口 -->
                <td>{if condition="$vo.target neq '_blank'"}<span class="layui-badge layui-bg-green">{:lang('current')}</span>{else}<span class="layui-badge">{:lang('blank')}</span>{/if} </td>
                <td>{$vo.parse}</td>
                <td>{$vo.des}</td>
                <td>{$vo.tip}</td>
                <td>
                    <!-- 导出按钮: 下载播放器配置 -->
                    <a class="layui-badge-rim" href="{:url('export?id='.$vo['from'])}" title="{:lang('export')}" style="padding: 0 15px;">{:lang('export')}</a>
                    <!-- 编辑按钮 -->
                    <a class="layui-badge-rim j-iframe" data-href="{:url('info?id='.$vo['from'])}" href="javascript:;" title="{:lang('edit')}">{:lang('edit')}</a>
                    <!-- 删除按钮 -->
                    <a class="layui-badge-rim j-tr-del" data-href="{:url('del?ids='.$vo['from'])}" href="javascript:;" title="{:lang('del')}">{:lang('del')}</a>
                </td>
            </tr>
            {/volist}
            </tbody>
        </table>

    </form>
</div>
{include file="../../../application/admin/view_new/public/foot" /}

<script type="text/javascript">
    layui.use(['form','laypage', 'layer'], function() {
        // Layui 组件
        var form = layui.form
                , layer = layui.layer
                , $ = layui.jquery;

        // 排序快速编辑 - 失去焦点或按回车时保存
        $(document).on('blur', '.j-sort-input', function() {
            var $this = $(this);
            var id = $this.data('id');
            var val = $this.val();
            var originalVal = $this.attr('data-original');

            // 如果值没变化，不提交
            if (val === originalVal) return;

            // 发送请求保存排序
            $.ajax({
                url: '{:url("field")}',
                type: 'POST',
                data: {
                    ids: id,
                    col: 'sort',
                    val: val
                },
                dataType: 'json',
                success: function(res) {
                    if (res.code === 1) {
                        // 更新原始值
                        $this.attr('data-original', val);
                        // 平滑刷新
                        smoothReload();
                    } else {
                        layer.msg(res.msg, {icon: 2});
                        $this.val(originalVal); // 恢复原值
                    }
                },
                error: function() {
                    layer.msg('请求失败', {icon: 2});
                    $this.val(originalVal);
                }
            });
        });

        $(document).on('keydown', '.j-sort-input', function(e) {
            // 按回车时触发保存
            if (e.keyCode === 13) {
                $(this).blur();
                return false;
            }
        });

        // 初始化：记录原始值
        $('.j-sort-input').each(function() {
            $(this).attr('data-original', $(this).val());
        });

        // 平滑刷新页面（带淡出淡入效果）
        function smoothReload() {
            var $container = $('.page-container');
            $container.css('opacity', '0.5');
            setTimeout(function() {
                location.reload();
            }, 100);
        }

        // 暴露刷新方法供外部调用
        window.refreshPlayerTable = smoothReload;
    });

    // iframe 弹窗关闭后刷新列表 (编辑/添加播放器后)
    function onIframeClose() {
        if (window.refreshPlayerTable) {
            window.refreshPlayerTable();
        } else {
            location.reload();
        }
    }
</script>
</body>
</html>